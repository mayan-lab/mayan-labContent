"use strict";
let mineralsJson = {
    "name": "Mineral",
    "name_zh": "矿物",
    "abbreviation": null,
    "formula": null,
    "latex_formula": null,
    "description": "",
    "description_zh": "自然晶体",
    "url": [
        {
            "index": "#",
            "img_url": "#",
        }
    ],
    "parent": null,
    "children": [
        {
            "name": "Native elements",
            "name_zh": "自然元素矿物",
            "abbreviation": null,
            "formula": null,
            "latex_formula": null,
            "description": "",
            "description_zh": "",
            "url": [
                {
                    "index": "#",
                    "img_url": "#",
                }
            ],
            "parent": "Mineral",
            "children": [
                {
                    "name": "Copper",
                    "name_zh": "自然铜",
                    "abbreviation": null,
                    "formula": null,
                    "latex_formula": null,
                    "description": "",
                    "description_zh": "",
                    "url": [
                        {
                            "index": "#",
                            "img_url": "#",
                        }
                    ],
                    "parent": "Native elements",

                },
                {
                    "name": "Gold",
                    "name_zh": "自然金",
                    "abbreviation": null,
                    "formula": null,
                    "latex_formula": null,
                    "description": "",
                    "description_zh": "",
                    "url": [
                        {
                            "index": "#",
                            "img_url": "#",
                        }
                    ],
                    "parent": "Native elements",
                    "children": [

                    ]
                },
                {
                    "name": "Silver",
                    "name_zh": "自然银",
                    "abbreviation": null,
                    "formula": null,
                    "latex_formula": null,
                    "description": "",
                    "description_zh": "",
                    "url": [
                        {
                            "index": "#",
                            "img_url": "#",
                        }
                    ],
                    "parent": "Native elements",
                    "children": [

                    ]
                },
                {
                    "name": "Platinum",
                    "name_zh": "自然铂",
                    "abbreviation": null,
                    "formula": null,
                    "latex_formula": null,
                    "description": "",
                    "description_zh": "",
                    "url": [
                        {
                            "index": "#",
                            "img_url": "#",
                        }
                    ],
                    "parent": "Native elements",
                    "children": [

                    ]
                },
                {
                    "name": "Selenium",
                    "name_zh": "自然硒",
                    "abbreviation": null,
                    "formula": null,
                    "latex_formula": null,
                    "description": "",
                    "description_zh": "",
                    "url": [
                        {
                            "index": "#",
                            "img_url": "#",
                        }
                    ],
                    "parent": "Native elements",
                    "children": [

                    ]
                },

            ]
        },
        {
            "name": "Intermetallic compound",
            "name_zh": "金属互化物矿物",
            "abbreviation": null,
            "formula": null,
            "latex_formula": null,
            "description": "",
            "description_zh": "",
            "url": [
                {
                    "index": "#",
                    "img_url": "#",
                }
            ],
            "parent": "Mineral",
            "children": [
                {
                    "name": "Luobushaite",
                    "name_zh": "罗布砂矿",
                    "abbreviation": null,
                    "formula": null,
                    "latex_formula": null,
                    "description": "",
                    "description_zh": "",
                    "url": [
                        {
                            "index": "#",
                            "img_url": "#",
                        }
                    ],
                    "parent": "Intermetallic compound",
                    "children": [

                    ]
                },
                {
                    "name": "Zangboite",
                    "name_zh": "藏布矿",
                    "abbreviation": null,
                    "formula": null,
                    "latex_formula": null,
                    "description": "",
                    "description_zh": "",
                    "url": [
                        {
                            "index": "#",
                            "img_url": "#",
                        }
                    ],
                    "parent": "Intermetallic compound",
                    "children": [

                    ]
                },
                {
                    "name": "Tongbaite",
                    "name_zh": "桐柏矿",
                    "abbreviation": null,
                    "formula": null,
                    "latex_formula": null,
                    "description": "",
                    "description_zh": "",
                    "url": [
                        {
                            "index": "#",
                            "img_url": "#",
                        }
                    ],
                    "parent": "Intermetallic compound",
                    "children": [

                    ]
                },

            ]
        },
        {
            "name": "Sulfide mineral",
            "name_zh": "硫化物矿物",
            "abbreviation": null,
            "formula": null,
            "latex_formula": null,
            "description": "",
            "description_zh": "自然晶体",
            "url": [
                {
                    "index": "#",
                    "img_url": "#",
                }
            ],
            "parent": "Mineral",
            "children": [
                {
                    "name": "Pyrite",
                    "name_zh": "黄铁矿",
                    "abbreviation": null,
                    "formula": null,
                    "latex_formula": null,
                    "description": "",
                    "description_zh": "自然晶体",
                    "url": [
                        {
                            "index": "#",
                            "img_url": "#",
                        }
                    ],
                    "parent": "Sulfide mineral",
                    "children": [

                    ]
                },
                {
                    "name": "Marcasite",
                    "name_zh": "白铁矿",
                    "abbreviation": null,
                    "formula": null,
                    "latex_formula": null,
                    "description": "",
                    "description_zh": "自然晶体",
                    "url": [
                        {
                            "index": "#",
                            "img_url": "#",
                        }
                    ],
                    "parent": "Sulfide mineral",
                    "children": [

                    ]
                },
                {
                    "name": "Marcasite",
                    "name_zh": "白铁矿",
                    "abbreviation": null,
                    "formula": null,
                    "latex_formula": null,
                    "description": "",
                    "description_zh": "自然晶体",
                    "url": [
                        {
                            "index": "#",
                            "img_url": "#",
                        }
                    ],
                    "parent": "Sulfide mineral",
                    "children": [

                    ]
                },

            ]
        },
        {
            "name": "Oxide and hydroxide mineral",
            "name_zh": "氧化物和氢氧化物矿物",
            "abbreviation": null,
            "formula": null,
            "latex_formula": null,
            "description": "",
            "description_zh": "",
            "url": [
                {
                    "index": "#",
                    "img_url": "#",
                }
            ],
            "parent": "Mineral",
            "children": [
                {
                    "name": "Arsenolite",
                    "name_zh": "砷华",
                    "abbreviation": null,
                    "formula": null,
                    "latex_formula": null,
                    "description": "",
                    "description_zh": "",
                    "url": [
                        {
                            "index": "#",
                            "img_url": "#",
                        }
                    ],
                    "parent": "Oxide and hydroxide mineral",
                    "children": [

                    ]
                },
                {
                    "name": "Rutile",
                    "name_zh": "金红石",
                    "abbreviation": null,
                    "formula": null,
                    "latex_formula": null,
                    "description": "",
                    "description_zh": "",
                    "url": [
                        {
                            "index": "#",
                            "img_url": "#",
                        }
                    ],
                    "parent": "Oxide and hydroxide mineral",
                    "children": [

                    ]
                },

            ]
        },
        {
            "name": "Silicate mineral",
            "name_zh": "硅酸盐矿物",
            "abbreviation": null,
            "formula": null,
            "latex_formula": null,
            "description": "",
            "description_zh": "",
            "url": [
                {
                    "index": "#",
                    "img_url": "#",
                }
            ],
            "parent": "Mineral",
            "children": [
                {
                    "name": "Zircon",
                    "name_zh": "锆石",
                    "abbreviation": null,
                    "formula": null,
                    "latex_formula": null,
                    "description": "",
                    "description_zh": "",
                    "url": [
                        {
                            "index": "#",
                            "img_url": "#",
                        }
                    ],
                    "parent": "Silicate mineral",
                    "children": [

                    ]
                },
                {
                    "name": "Garnet",
                    "name_zh": "石榴子石",
                    "abbreviation": null,
                    "formula": null,
                    "latex_formula": null,
                    "description": "",
                    "description_zh": "",
                    "url": [
                        {
                            "index": "#",
                            "img_url": "#",
                        }
                    ],
                    "parent": "Silicate mineral",
                    "children": [

                    ]
                },
                {
                    "name": "Olivine",
                    "name_zh": "橄榄石",
                    "abbreviation": null,
                    "formula": null,
                    "latex_formula": null,
                    "description": "",
                    "description_zh": "",
                    "url": [
                        {
                            "index": "#",
                            "img_url": "#",
                        }
                    ],
                    "parent": "Silicate mineral",
                    "children": [

                    ]
                },
                {
                    "name": "Andalusite",
                    "name_zh": "红柱石",
                    "abbreviation": null,
                    "formula": null,
                    "latex_formula": null,
                    "description": "",
                    "description_zh": "",
                    "url": [
                        {
                            "index": "#",
                            "img_url": "#",
                        }
                    ],
                    "parent": "Silicate mineral",
                    "children": [

                    ]
                },

            ]
        },
        {
            "name": "Carbonate mineral",
            "name_zh": "碳酸盐矿物",
            "abbreviation": null,
            "formula": null,
            "latex_formula": null,
            "description": "",
            "description_zh": "",
            "url": [
                {
                    "index": "#",
                    "img_url": "#",
                }
            ],
            "parent": "Mineral",
            "children": [
                {
                    "name": "Calcite",
                    "name_zh": "方解石",
                    "abbreviation": null,
                    "formula": null,
                    "latex_formula": null,
                    "description": "",
                    "description_zh": "",
                    "url": [
                        {
                            "index": "#",
                            "img_url": "#",
                        }
                    ],
                    "parent": "Carbonate mineral",
                    "children": [

                    ]
                },
                {
                    "name": "Magnesite",
                    "name_zh": "菱镁矿",
                    "abbreviation": null,
                    "formula": null,
                    "latex_formula": null,
                    "description": "",
                    "description_zh": "",
                    "url": [
                        {
                            "index": "#",
                            "img_url": "#",
                        }
                    ],
                    "parent": "Carbonate mineral",
                    "children": [

                    ]
                },

            ]
        },
        {
            "name": "Sulfate mineral",
            "name_zh": "硫酸盐矿物",
            "abbreviation": null,
            "formula": null,
            "latex_formula": null,
            "description": "",
            "description_zh": "",
            "url": [
                {
                    "index": "#",
                    "img_url": "#",
                }
            ],
            "parent": "Mineral",
            "children": [
                {
                    "name": "Barite",
                    "name_zh": "重晶石",
                    "abbreviation": null,
                    "formula": null,
                    "latex_formula": null,
                    "description": "",
                    "description_zh": "",
                    "url": [
                        {
                            "index": "#",
                            "img_url": "#",
                        }
                    ],
                    "parent": "Sulfate mineral",
                    "children": [

                    ]
                },
                {
                    "name": "Celestine",
                    "name_zh": "天青石",
                    "abbreviation": null,
                    "formula": null,
                    "latex_formula": null,
                    "description": "",
                    "description_zh": "",
                    "url": [
                        {
                            "index": "#",
                            "img_url": "#",
                        }
                    ],
                    "parent": "Sulfate mineral",
                    "children": [

                    ]
                },
                {
                    "name": "Anhydrite",
                    "name_zh": "硬石膏",
                    "abbreviation": null,
                    "formula": null,
                    "latex_formula": null,
                    "description": "",
                    "description_zh": "",
                    "url": [
                        {
                            "index": "#",
                            "img_url": "#",
                        }
                    ],
                    "parent": "Sulfate mineral",
                    "children": [

                    ]
                },

            ]
        },
        {
            "name": "Phosphate mineral",
            "name_zh": "磷酸盐矿物",
            "abbreviation": null,
            "formula": null,
            "latex_formula": null,
            "description": "",
            "description_zh": "",
            "url": [
                {
                    "index": "#",
                    "img_url": "#",
                }
            ],
            "parent": "Mineral",
            "children": [
                {
                    "name": "Monazite",
                    "name_zh": "独居石",
                    "abbreviation": null,
                    "formula": null,
                    "latex_formula": null,
                    "description": "",
                    "description_zh": "",
                    "url": [
                        {
                            "index": "#",
                            "img_url": "#",
                        }
                    ],
                    "parent": "Phosphate mineral",
                    "children": [

                    ]
                },
                {
                    "name": "Apatite",
                    "name_zh": "磷灰石",
                    "abbreviation": null,
                    "formula": null,
                    "latex_formula": null,
                    "description": "",
                    "description_zh": "",
                    "url": [
                        {
                            "index": "#",
                            "img_url": "#",
                        }
                    ],
                    "parent": "Phosphate mineral",
                    "children": [

                    ]
                },

            ]
        },
        {
            "name": "Borate mineral",
            "name_zh": "硼酸盐矿物",
            "abbreviation": null,
            "formula": null,
            "latex_formula": null,
            "description": "",
            "description_zh": "",
            "url": [
                {
                    "index": "#",
                    "img_url": "#",
                }
            ],
            "parent": "Mineral",
            "children": [
                {
                    "name": "Ludwigite",
                    "name_zh": "硼镁铁矿",
                    "abbreviation": null,
                    "formula": null,
                    "latex_formula": null,
                    "description": "",
                    "description_zh": "",
                    "url": [
                        {
                            "index": "#",
                            "img_url": "#",
                        }
                    ],
                    "parent": "Borate mineral",
                    "children": [

                    ]
                },
                {
                    "name": "Ascharite",
                    "name_zh": "硼镁石",
                    "abbreviation": null,
                    "formula": null,
                    "latex_formula": null,
                    "description": "",
                    "description_zh": "",
                    "url": [
                        {
                            "index": "#",
                            "img_url": "#",
                        }
                    ],
                    "parent": "Borate mineral",
                    "children": [

                    ]
                },

            ]
        },
        // {
        //     "name": "Tungstate, molybdate and chromate mineral",
        //     "name_zh": "钨酸盐、钼酸盐和铬酸盐矿物",
        //     "abbreviation": null,
        //     "formula": null,
        //     "latex_formula": null,
        //     "description": "",
        //     "description_zh": "",
        //     "url": [
        //         {
        //             "index": "#",
        //             "img_url": "#",
        //         }
        //     ],
        //     "parent": "Mineral",
        //     "children": [
        //         {
        //
        //         },
        //
        //     ]
        // },
        {
            "name": "Halide mineral",
            "name_zh": "卤化物矿物",
            "abbreviation": null,
            "formula": null,
            "latex_formula": null,
            "description": "",
            "description_zh": "",
            "url": [
                {
                    "index": "#",
                    "img_url": "#",
                }
            ],
            "parent": "Mineral",
            "children": [
                {
                    "name": "Fluorite",
                    "name_zh": "萤石",
                    "abbreviation": null,
                    "formula": null,
                    "latex_formula": null,
                    "description": "",
                    "description_zh": "",
                    "url": [
                        {
                            "index": "#",
                            "img_url": "#",
                        }
                    ],
                    "parent": "Halide mineral",
                    "children": [

                    ]
                },
                {
                    "name": "Halite",
                    "name_zh": "石盐",
                    "abbreviation": null,
                    "formula": null,
                    "latex_formula": null,
                    "description": "",
                    "description_zh": "",
                    "url": [
                        {
                            "index": "#",
                            "img_url": "#",
                        }
                    ],
                    "parent": "Halide mineral",
                    "children": [

                    ]
                },

            ]
        },
        {
            "name": "Organic, mineraloid mineral",
            "name_zh": "有机及准矿物",
            "abbreviation": null,
            "formula": null,
            "latex_formula": null,
            "description": "",
            "description_zh": "",
            "url": [
                {
                    "index": "#",
                    "img_url": "#",
                }
            ],
            "parent": "Mineral",
            "children": [
                {
                    "name": "Coal",
                    "name_zh": "煤",
                    "abbreviation": null,
                    "formula": null,
                    "latex_formula": null,
                    "description": "",
                    "description_zh": "",
                    "url": [
                        {
                            "index": "#",
                            "img_url": "#",
                        }
                    ],
                    "parent": "Organic, mineraloid mineral",
                    "children": [

                    ]
                },

            ]
        },

    ]

};

let duration = 400;


let width = 900;
let height = 1400;
let treeWidth = width - 50;
let treeHeight = height - 50;
let svg = d3.select("#herizontalmineraltree")
    .append('svg')
    .attr('width', '100%')
    .attr('height', treeHeight);

let rect = svg.append('rect')
    .attr('width', '100%')
    .attr('height', '100%')
    .attr('fill', '#dcdcdc');

let gTree = svg.append('g')
    .attr('transform', 'translate(10,0)');

let treeMineral = d3.tree()
    .size([treeWidth, treeHeight]);

let  root = d3.hierarchy(mineralsJson, d => d.children);

let renderHorLinks = d3.linkHorizontal().x(d => d.y).y(d => d.x);

// let root = treeMineral(mineralTreeData);
root.x0 = height / 2;
root.y0 = 150;
root.children.forEach(collapse);

updateTree(root);
// collapse all node and its children
function collapse(d) {
    if (d.children) {
        d._children = d.children
        d._children.forEach(collapse)
        d.children = null
    }
}
// gTree.append('g');
function updateTree(source) {
    let treeData = treeMineral(root);

    let nodes = treeData.descendants();
    let linkss = treeData.links();
    let links = treeData.descendants().slice(1);

    nodes.forEach(d => d.y = d.depth * 250);

    // Nodes section

    let node = gTree.selectAll('g.node')
        .data(nodes, (d, i) => d.id || (d.id = ++ i));

    let nodeEnter = node.enter().append('g')
        .attr('class', 'node')
        .attr("font-family", "sans-serif")
        .attr("font-size", 12)
        .attr('transform', `translate(${source.y0}, ${source.x0})`)
        .on('click', nodeClick);

    nodeEnter.append('circle')
        .attr('class', 'node')
        .attr('r', 1e-6)
        .attr('stroke', '#29a8ff')
        .attr('stroke-width', '0.5')
        .attr('fill', d => d._children ? '#ffffff' : '#7b7b7b');

    nodeEnter.append('text')
        .attr('dy', '.35em')
        .attr('x', d => d.children || d._children ? -6 : 6)
        .attr('fill', '#000')
        .attr('text-anchor', d => d.children || d._children ? 'end' : 'start')
        .text(d => d.data.name_zh);

    let nodeUpdate = nodeEnter.merge(node);

    nodeUpdate.transition()
        .duration(duration)
        .attr('transform', d => `translate(${d.y}, ${d.x})`);

    nodeUpdate.select('circle.node')
        .attr('r', 4)
        .attr('fill', d => d._children ? '#f80707' : '#23ec07')

    let nodeExit = node.exit().transition()
        .duration(duration)
        .attr('transform', `translate(${source.y}, ${source.x})`)
        .remove();

    nodeExit.select('circle')
        .attr('r', 1e-6);

    nodeExit.select('text')
        .attr('fill-opacity', 1e-6);

    // updata the links
    let link = gTree.selectAll('path.link')
        .data(links, d => d.id);

    let linkEnter = link.enter().insert('path', 'g')
        .attr('class', 'link')
        .attr('fill', 'none')
        .attr('stroke', '#404040')
        .attr('d', d => {
            let o = {x: source.x, y: source.y}
            return diagonal(o, o)
        });



    let linkUpdate = linkEnter.merge(link);

    linkUpdate.transition()
        .duration(duration)
        .attr('d', d => diagonal(d, d.parent));

    let linkExit = link.exit().transition()
        .duration(duration)
        .attr('d', d => {
            let o = {x: source.x, y: source.y}
            diagonal(o, o)
        })
        .remove();

    nodes.forEach(d => {
        d.x0 = d.x
        d.y0 = d.y
    });

    function nodeClick(d) {
        if (d.children) {
            d._children = d.children;
            d.children = null;
        } else {
            d.children = d._children;
            d._children = null;
        }
        updateTree(d);
    }

}
function diagonal(s, d) {

    let path = `M ${s.y} ${s.x}
            C ${(s.y + d.y) / 2} ${s.x},
              ${(s.y + d.y) / 2} ${d.x},
              ${d.y} ${d.x}`

    return path
}



